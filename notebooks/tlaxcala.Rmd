---
title: "R Notebook"
output: html_notebook
---

```{r}
dotenv::load_dot_env("../.env")
library(dbrsocial)
```

```{r}
library(ggplot2)
library(tidyverse)
library(plyr)
library(dplyr)
library(scales)
library(maptools)
library(rgdal)
library(ggmap)
library(gridExtra)
library(rgdal)
library(Hmisc)
library(rgeos)
library(sp)
library(sf)
library(rgeos)
library(broom)

library(odbc)
library(rangeMapper)
library(ggmap)
library(plotly)
```

### DB conections
```{r, echo=FALSE}
con <- pub_connect(s3dir = Sys.getenv("S3_DIR"), schema = Sys.getenv("SCHEMA"))
```

### Dejamos esta función porque por alguna razón no se carga al instalar el paquete ):
```{r}
load_query <- function(connection,schema,the_table,columns="*",options=""){
    the_query <- "SELECT %s FROM %s.%s"
    complete <- paste0(the_query," ",options)
    schema    <- deparse(substitute(schema))
    the_table <- deparse(substitute(the_table))
    initial <- RPostgreSQL::dbSendQuery(connection,
                             sprintf(complete,columns,schema,the_table))
}
```


### Catálogo de queries
```{r, echo=FALSE}
los_queries <- query_dic()
```

### Catálogo de Beneficios
```{r, echo=FALSE}
catalogo_beneficios <- csv_s3()
colnames(catalogo_beneficios) <- c("cd_beneficio","nb_beneficio")
catalogo_beneficios
```


### Cargar los mapas de Tlaxcala
```{r}
con1 <- prev_connect()

columns <- "cve_mun, cve_ent, cve_muni, ST_AsText(geom) as geom"
options <- "WHERE cve_ent = '29'"
geom_tlax <- load_query(con1,raw,geom_municipios,columns,options) %>%
        retrieve_result()

mun_shp = WKT2SpatialPolygonsDataFrame(geom_tlax, geom = 'geom', id = 'cve_muni')
mun_df <- fortify(mun_shp, region = "cve_muni")
names(mun_df)[names(mun_df)=="id"] <- "cve_muni"
```


### Beneficiarios en Tlaxcala
```{r}
query <- "SELECT cvemuni, count(distinct newid) as cuenta
          FROM athena_pub.pub_nominal
          WHERE cveent='29'
          GROUP BY cvemuni
          ORDER BY cuenta DESC"

c(ben_tlax,los_queries) := load_or_run(con,query,los_queries)
colnames(ben_tlax) <- c("cve_muni","cuenta")
ben_tlax$cve_muni <- as.character(ben_tlax$cve_muni)
cuentas <- ben_tlax
```

```{r, echo=FALSE}
los_estados <- read_csv("../estados.csv")
colnames(los_estados) <- c("num","id","pagos","distintos")
```

### Número de beneficiarios
```{r}
edos <- mun_df %>%
  left_join(cuentas)

ggplot() + 
  geom_polygon(data = edos, aes(long, lat, group=group, fill=cuenta))+
  labs(title="Número de NA en identificadores", fill="Número de beneficiarios")+
  coord_map(projection="mercator") +
  coord_fixed()
```

### Dinero por municipio
```{r}
query <- "SELECT cvemuni, sum(nuimpmonetario) as monto
              FROM athena_pub.pub_nominal
              GROUP BY cvemuni"
              
c(dinero_mun,los_queries) := load_or_run(con,query,los_queries)
dinero_mun
```

```{r}
colnames(dinero_mun) <- c("cve_muni","cuenta")

edos <- mun_df %>%
  left_join(dinero_mun)

ggplot() + 
  geom_polygon(data = edos, aes(long, lat, group=group, fill=cuenta))+
  labs(title="Suma de montos pagados por municipio", fill="monto")+
  coord_map(projection="mercator") +
  coord_fixed()
```


### Dinero por municipio
```{r}
query <- "SELECT cvemuni, newid
              FROM athena_pub.pub_nominal
              WHERE cveent='29'
              GROUP BY newid, cvemuni"
              
c(dinero_mun_per,los_queries) := load_or_run(con,query,los_queries)
dinero_mun_per
```

```{r}
colnames(dinero_mun) <- c("cve_muni","cuenta")

edos <- mun_df %>%
  left_join(dinero_mun)

ggplot() + 
  geom_polygon(data = edos, aes(long, lat, group=group, fill=cuenta))+
  labs(title="Suma de montos pagados por municipio", fill="monto")+
  coord_map(projection="mercator") +
  coord_fixed()
```


### Distribución de pago por programa
```{r}
query <- "SELECT cdprograma, nuimpmonetario
              FROM athena_pub.pub_nominal
              WHERE cveent='29'"
              
c(dinero_programa,los_queries) := load_or_run(con,query,los_queries)
dinero_programa
```

```{r}
box_programa <- ggplot(dinero_programa, aes(x = cdprograma, y = nuimpmonetario, fill=cdprograma)) +
        geom_boxplot() +
        theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
        scale_y_log10()
box_programa
boxly <- ggplotly(box_programa)
htmlwidgets::saveWidget(boxly, "/home/ollin18/index.html")
ggsave("/home/ollin18/program_box_tlax.png",width=25,height=7)
```


### Contar el número de distintos newid, ver cuánto se les paga en total con municipio
```{r}
query <- "SELECT cvemuni, count(distinct newid) as iden, cdprograma, sum(nuimpmonetario) as monto, cdbeneficio
              FROM athena_pub.pub_nominal
              WHERE cveent='29'
              GROUP BY cdprograma, cdbeneficio, cvemuni"

              
c(num_per,los_queries) := load_or_run(con,query,los_queries)
```

### Suma de pagos por distintas personas
```{r}
query <- "SELECT cvemuni, count(distinct newid) as iden, sum(nuimpmonetario) as monto
              FROM athena_pub.pub_nominal
              WHERE cveent='29'
              GROUP BY cvemuni"

c(pago_por_persona,los_queries) := load_or_run(con,query,los_queries)
pago_por_persona <- mutate(pago_por_persona,ratio=monto/iden)
```

```{r}
colnames(pago_por_persona)[which(names(pago_por_persona) == "cvemuni")] <- "cve_muni"
pago_por_persona$cve_muni <- as.character(pago_por_persona$cve_muni)

edos <- mun_df %>%
  left_join(pago_por_persona)

ggplot() + 
  geom_polygon(data = edos, aes(long, lat, group=group, fill=ratio))+
  labs(title="Suma de montos pagados por municipio", fill="monto")+
  coord_map(projection="mercator") +
  coord_fixed()
```


### Distribución de pago por programa mensual
```{r}
query <- "SELECT anio, numespago, cdprograma, sum(nuimpmonetario) as monto, newid
              FROM athena_pub.pub_nominal
              WHERE cveent='29'
              GROUP BY anio, newid, numespago, cdprograma"
              
c(dinero_programa_mensual,los_queries) := load_or_run(con,query,los_queries)
dinero_programa_mensual
```





